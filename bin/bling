#!/usr/bin/env ruby

require 'rubygems'
gem 'bling'
require 'bling'

$task = <<-rakefile
require 'rubygems'
gem 'bling'
require 'bling'

namespace :bling do
  desc 'shows gems that are required for the given env'
  task :show do
		file = File.join(File.dirname(__FILE__), "..", "..", "bling.yml")
		Bling.new(file).list_gems(ENV['RAILS_ENV'])
  end

end
rakefile

if gem_version =~ /^2\./
  $yaml = <<-yml
all:
  - name: rails
    version: #{gem_version}
yml

  $boot = File.read("config/boot.rb")
  $boot.gsub! /      def load_rubygems/, <<-boot
      def load_rubygems
        gem 'bling'
        require 'bling'
      end
      def old_load_rubygems
boot
  
else
  $yaml = <<-yml
all:
  - name: rails
    version: 3.0.0.beta
yml

  $boot = <<-bootfile
  begin
    require 'rubygems'
    gem 'bling'
    require 'bling'
  end
  bootfile
end

$final = <<-output
	You still need to do one thing before you're BLING BLINGing!

	You need to change the line in your application.rb from:

		Bundler.require :default, Rails.env

	to
		
		Bling.new(File.join(File.dirname(__FILE__), "..", "bling.yml")).require_env(Rails.env)
output

def init
	if !File.exists?("config/boot.rb")
		puts "Needs to be run from Rails root directory"
		exit(1)
	end
	
	File.open("lib/tasks/bling.rake", "w") do |f|
		f.write($task)
	end
	
	File.open("config/boot.rb", "w") do |f|
		f.write($boot)
	end
	
	File.open("bling.yml", "w") do |f|
		f.write($yaml)
	end
	
	puts $final
end

def install
	bling_file = "bling.yml"

	if !File.exists?(bling_file)
		puts "No bling file found"
		exit(1)
	end

	Bling.new(bling_file).install_gems(ENV['RAILS_ENV'] || "development")
end

def gem_version
  ENV.include?('RAILS_GEM_VERSION')
    ENV['RAILS_GEM_VERSION']
  else
    parse_gem_version(read_environment_rb)
  end
end

def parse_gem_version(text)
  $1 if text =~ /^[^#]*RAILS_GEM_VERSION\s*=\s*["']([!~<>=]*\s*[\d.]+)["']/
end

def read_environment_rb
  File.read("config/environment.rb")
end

if ARGV[0] == "install"
	install
elsif ARGV[0] == "init"
	init
else
	puts "Unrecognized command. Available command: install"
end
